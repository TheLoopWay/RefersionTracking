<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Refersion + HubSpot Integration</title>

    <!-- Refersion v4 Tracking Script - Replace YOUR-REFERSION-PUBLIC-KEY -->
    <script>
      (function (a, b, c, d, e, f, g) {
        e["refersion"] = c;
        e[c] =
          e[c] ||
          function () {
            (e[c].q = e[c].q || []).push(arguments);
          };
        f = b.createElement(a);
        g = b.getElementsByTagName(a)[0];
        f.async = 1;
        f.src = d;
        g.parentNode.insertBefore(f, g);
      })("script", document, "r", "https://cdn.refersion.com/refersion.js");
      r("pubkey", "YOUR-REFERSION-PUBLIC-KEY");
    </script>

    <!-- HubSpot Tracking Code -->
    <script
      type="text/javascript"
      id="hs-script-loader"
      async
      defer
      src="//js.hs-scripts.com/242518594.js"
    ></script>

    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <h1>Refersion + HubSpot Integration Demo</h1>

    <div class="container">
      <!-- Tracking Status Panel -->
      <div class="tracking-panel">
        <h2>üìä Tracking Status</h2>

        <div class="status-item">
          <span class="status-label">Referral ID:</span>
          <span id="referral-id" class="status-value inactive">None</span>
        </div>

        <div class="status-item">
          <span class="status-label">Captured:</span>
          <span id="capture-time" class="status-value inactive">N/A</span>
        </div>

        <div class="status-item">
          <span class="status-label">Source URL:</span>
          <span id="source-url" class="status-value inactive">N/A</span>
        </div>

        <div class="status-item">
          <span class="status-label">HubSpot UTK:</span>
          <span id="hubspot-utk" class="status-value inactive">None</span>
        </div>

        <div class="test-links">
          <h2>üß™ Test Links</h2>
          <a href="?rfsn=DEMO123.affiliate">Test Referral Link 1</a>
          <a href="?rfsn=PARTNER456.xyz&utm_source=email"
            >Test Referral Link 2</a
          >
          <a href="/">Clear Parameters</a>
        </div>

        <div class="controls">
          <h2>üõ†Ô∏è Controls</h2>
          <button onclick="clearTrackingData()">Clear All Tracking Data</button>
        </div>
        
        <div class="controls" style="margin-top: 15px;">
          <h2>üìö Resources</h2>
          <a href="squarespace-embed-guide.html" style="display: block; padding: 10px 15px; background-color: #27ae60; color: white; text-decoration: none; border-radius: 5px; text-align: center; transition: background-color 0.3s;">
            View Squarespace Embed Guide
          </a>
        </div>
      </div>

      <!-- Form Container -->
      <div class="form-container">
        <div id="success-message" class="success-message">
          ‚úÖ Form submitted successfully! Check your HubSpot contacts for the
          tracking data.
        </div>

        <h2>Contact Form</h2>
        <p>
          Fill out this form to test the Refersion tracking integration. The
          hidden fields will automatically populate with any referral data.
        </p>

        <!-- HubSpot Form Container -->
        <div id="hubspot-form"></div>
      </div>
    </div>

    <!-- HubSpot Forms API -->
    <script
      charset="utf-8"
      type="text/javascript"
      src="//js-na2.hsforms.net/forms/v2.js"
    ></script>
    <script>
      // Refersion + HubSpot Integration
      (function () {
        "use strict";

        // Helper functions
        function updateTrackingDisplay() {
          const rfsnId = localStorage.getItem("rfsn");
          const timestamp = localStorage.getItem("rfsn_timestamp");
          const sourceUrl = localStorage.getItem("rfsn_source_url");
          const hubspotutk = document.cookie.replace(
            /(?:(?:^|.*;\s*)hubspotutk\s*\=\s*([^;]*).*$)|^.*$/,
            "$1"
          );

          // Update display
          document.getElementById("referral-id").textContent = rfsnId || "None";
          document.getElementById("referral-id").className = rfsnId
            ? "status-value active"
            : "status-value inactive";

          document.getElementById("capture-time").textContent = timestamp
            ? new Date(timestamp).toLocaleString()
            : "N/A";
          document.getElementById("capture-time").className = timestamp
            ? "status-value"
            : "status-value inactive";

          document.getElementById("source-url").textContent =
            sourceUrl || "N/A";
          document.getElementById("source-url").className = sourceUrl
            ? "status-value"
            : "status-value inactive";

          document.getElementById("hubspot-utk").textContent =
            hubspotutk || "None";
          document.getElementById("hubspot-utk").className = hubspotutk
            ? "status-value"
            : "status-value inactive";
        }

        function captureRefersionData() {
          const urlParams = new URLSearchParams(window.location.search);
          const rfsnParam = urlParams.get("rfsn") || urlParams.get("RFSN");

          if (rfsnParam) {
            // Store new referral data
            localStorage.setItem("rfsn", rfsnParam);
            localStorage.setItem("rfsn_timestamp", new Date().toISOString());
            localStorage.setItem("rfsn_source_url", window.location.href);

            // Track with Refersion
            if (typeof r !== "undefined") {
              r("click", rfsnParam);
            }

            console.log("[Refersion] New referral captured:", rfsnParam);
            updateTrackingDisplay();

            return {
              affiliateId: rfsnParam,
              timestamp: localStorage.getItem("rfsn_timestamp"),
              sourceUrl: window.location.href,
            };
          }

          // Return existing data if no new referral
          const existingId = localStorage.getItem("rfsn");
          if (existingId) {
            return {
              affiliateId: existingId,
              timestamp: localStorage.getItem("rfsn_timestamp") || "",
              sourceUrl: localStorage.getItem("rfsn_source_url") || "",
            };
          }

          return null;
        }

        window.clearTrackingData = function () {
          localStorage.removeItem("rfsn");
          localStorage.removeItem("rfsn_timestamp");
          localStorage.removeItem("rfsn_source_url");
          updateTrackingDisplay();
          alert("Tracking data cleared! Refresh the page to reload the form.");
        };

        // Initialize display
        updateTrackingDisplay();

        // Capture referral data
        const refersionData = captureRefersionData();

        // Load HubSpot form
        function loadHubSpotForm() {
          if (window.hbspt && window.hbspt.forms) {
            hbspt.forms.create({
              region: "na2",
              portalId: "242518594",
              formId: "565af379-e462-4953-8aa3-0def5da100ca",
              target: "#hubspot-form",

              onFormReady: function ($form) {
                console.log("[HubSpot] Form ready");

                if (refersionData) {
                  // Populate hidden fields
                  const fields = [
                    {
                      name: "refersionid",  // Using existing HubSpot property
                      value: refersionData.affiliateId,
                    },
                    {
                      name: "refersion_timestamp",
                      value: refersionData.timestamp,
                    },
                    {
                      name: "refersion_source_url",
                      value: refersionData.sourceUrl,
                    },
                  ];

                  fields.forEach((field) => {
                    const $input = $form.find(`input[name="${field.name}"]`);
                    if ($input.length) {
                      $input.val(field.value).change();
                      console.log(
                        `[HubSpot] Set ${field.name} to:`,
                        field.value
                      );
                    } else {
                      console.warn(
                        `[HubSpot] Hidden field ${field.name} not found in form`
                      );
                    }
                  });
                }
              },

              onFormSubmit: function ($form) {
                console.log("[HubSpot] Form submitted with referral tracking");
              },

              onFormSubmitted: function () {
                console.log("[HubSpot] Form submission complete");
                document.getElementById("success-message").style.display =
                  "block";

                // Scroll to success message
                document
                  .getElementById("success-message")
                  .scrollIntoView({ behavior: "smooth" });
              },
            });
          } else {
            // Retry if library not loaded
            setTimeout(loadHubSpotForm, 100);
          }
        }

        // Start loading form
        loadHubSpotForm();

        // Listen for HubSpot events
        window.addEventListener("message", function (event) {
          if (event.data.type === "hsFormCallback") {
            console.log("[HubSpot] Form event:", event.data.eventName);
          }
        });
      })();
    </script>
  </body>
</html>
