<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Squarespace Embed Code Guide - Refersion + HubSpot</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f7fa;
        line-height: 1.8;
      }
      .header {
        background-color: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }
      h1 {
        color: #2c3e50;
        margin: 0 0 10px 0;
      }
      .subtitle {
        color: #7f8c8d;
        font-size: 18px;
      }
      .section {
        background-color: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      h2 {
        color: #34495e;
        margin-top: 0;
        border-bottom: 2px solid #e8e8e8;
        padding-bottom: 10px;
      }
      h3 {
        color: #2c3e50;
        margin-top: 25px;
      }
      .code-container {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 5px;
        padding: 20px;
        margin: 15px 0;
        position: relative;
      }
      pre {
        margin: 0;
        overflow-x: auto;
      }
      code {
        font-family: "Consolas", "Monaco", "Courier New", monospace;
        font-size: 14px;
        line-height: 1.5;
      }
      .copy-button {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: #3498db;
        color: white;
        border: none;
        padding: 5px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
      }
      .copy-button:hover {
        background-color: #2980b9;
      }
      .warning {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
        padding: 15px;
        border-radius: 5px;
        margin: 15px 0;
      }
      .success {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
        padding: 15px;
        border-radius: 5px;
        margin: 15px 0;
      }
      .info {
        background-color: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
        padding: 15px;
        border-radius: 5px;
        margin: 15px 0;
      }
      .step-number {
        display: inline-block;
        width: 30px;
        height: 30px;
        background-color: #3498db;
        color: white;
        border-radius: 50%;
        text-align: center;
        line-height: 30px;
        margin-right: 10px;
        font-weight: bold;
      }
      ul {
        padding-left: 20px;
      }
      li {
        margin-bottom: 10px;
      }
      .highlight {
        background-color: #ffeb3b;
        padding: 2px 4px;
        border-radius: 3px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
      }
      th,
      td {
        text-align: left;
        padding: 12px;
        border-bottom: 1px solid #ddd;
      }
      th {
        background-color: #f8f9fa;
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>Squarespace Embed Code Guide</h1>
      <p class="subtitle">
        Complete implementation guide for Refersion + HubSpot tracking on
        Squarespace
      </p>
    </div>

    <div class="section">
      <h2>üìã Overview: What Goes Where</h2>

      <table>
        <tr>
          <th>Script Type</th>
          <th>Where to Place</th>
          <th>Purpose</th>
        </tr>
        <tr>
          <td><strong>Global Scripts</strong></td>
          <td>Settings ‚Üí Advanced ‚Üí Code Injection ‚Üí Header</td>
          <td>Tracking scripts that run on every page</td>
        </tr>
        <tr>
          <td><strong>Form Integration</strong></td>
          <td>Specific page with HubSpot form</td>
          <td>Connects referral data to form submissions</td>
        </tr>
        <tr>
          <td><strong>Conversion Tracking</strong></td>
          <td>Order confirmation page only</td>
          <td>Tracks completed purchases</td>
        </tr>
      </table>
    </div>

    <div class="section">
      <h2><span class="step-number">1</span>Global Scripts (Every Page)</h2>
      <p>
        Add this to
        <strong>Settings ‚Üí Advanced ‚Üí Code Injection ‚Üí Header</strong>
      </p>

      <div class="warning">
        <strong>‚ö†Ô∏è Important:</strong> Replace
        <code class="highlight">YOUR-REFERSION-PUBLIC-KEY</code> with your
        actual Refersion public API key
      </div>

      <div class="code-container">
        <button class="copy-button" onclick="copyCode('global-scripts')">
          Copy
        </button>
        <pre><code id="global-scripts">&lt;!-- Refersion v4 Tracking Script --&gt;
&lt;script&gt;
(function(a,b,c,d,e,f,g){e['refersion']=c;e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)};f=b.createElement(a);g=b.getElementsByTagName(a)[0];f.async=1;f.src=d;g.parentNode.insertBefore(f,g)})("script",document,"r","https://cdn.refersion.com/refersion.js");
r('pubkey', 'YOUR-REFERSION-PUBLIC-KEY');
&lt;/script&gt;

&lt;!-- HubSpot Tracking Code --&gt;
&lt;script type="text/javascript" id="hs-script-loader" async defer src="//js.hs-scripts.com/242518594.js"&gt;&lt;/script&gt;

&lt;!-- Refersion Click Tracking &amp; HubSpot Form Integration --&gt;
&lt;script&gt;
// Capture Refersion referral data on every page
(function() {
    'use strict';
    
    // Capture referral from URL
    function captureRefersion() {
        const urlParams = new URLSearchParams(window.location.search);
        const rfsnParam = urlParams.get('rfsn') || urlParams.get('RFSN');
        
        if (rfsnParam) {
            // Store in localStorage
            localStorage.setItem('rfsn', rfsnParam);
            localStorage.setItem('rfsn_timestamp', new Date().toISOString());
            localStorage.setItem('rfsn_source_url', window.location.href);
            
            // Track click with Refersion
            if (typeof r !== 'undefined') {
                r('click', rfsnParam);
            }
            
            console.log('[Refersion] Referral captured:', rfsnParam);
        }
    }
    
    // Run on page load
    captureRefersion();
})();
&lt;/script&gt;</code></pre>
      </div>

      <div class="info">
        <strong>‚ÑπÔ∏è What this does:</strong>
        <ul>
          <li>Loads Refersion tracking on every page</li>
          <li>Loads HubSpot tracking on every page</li>
          <li>Captures referral IDs from URLs (?rfsn=XXXXX)</li>
          <li>Stores referral data in browser localStorage</li>
          <li>Tracks clicks with Refersion automatically</li>
        </ul>
      </div>
    </div>

    <div class="section">
      <h2>
        <span class="step-number">2</span>HubSpot Form Integration (Form Pages
        Only)
      </h2>
      <p>
        Add this to pages with HubSpot forms using a <strong>Code Block</strong>
      </p>

      <h3>Option A: Using HubSpot Forms API (Recommended)</h3>
      <div class="code-container">
        <button class="copy-button" onclick="copyCode('form-api')">Copy</button>
        <pre><code id="form-api">&lt;!-- HubSpot Form Container --&gt;
&lt;div id="hubspot-form"&gt;&lt;/div&gt;

&lt;!-- Load HubSpot Forms Library --&gt;
&lt;script charset="utf-8" type="text/javascript" src="//js.hsforms.net/forms/v2.js"&gt;&lt;/script&gt;
&lt;script&gt;
hbspt.forms.create({
    region: "na2",
    portalId: "242518594",
    formId: "YOUR-FORM-ID",  // Replace with your form ID
    target: "#hubspot-form",
    
    onFormReady: function($form) {
        // Get stored Refersion data
        const rfsnId = localStorage.getItem('rfsn');
        const timestamp = localStorage.getItem('rfsn_timestamp');
        const sourceUrl = localStorage.getItem('rfsn_source_url');
        
        if (rfsnId) {
            // Populate hidden fields
            const fields = [
                { name: 'refersionid', value: rfsnId },
                { name: 'refersion_timestamp', value: timestamp || '' },
                { name: 'refersion_source_url', value: sourceUrl || '' }
            ];
            
            fields.forEach(function(field) {
                const $input = $form.find('input[name="' + field.name + '"]');
                if ($input.length) {
                    $input.val(field.value).change();
                    console.log('[HubSpot] Set ' + field.name + ' to:', field.value);
                }
            });
        }
    }
});
&lt;/script&gt;</code></pre>
      </div>

      <h3>Option B: For Existing Embedded Forms</h3>
      <p>
        If you already have HubSpot forms embedded, add this script after the
        form:
      </p>

      <div class="code-container">
        <button class="copy-button" onclick="copyCode('form-existing')">
          Copy
        </button>
        <pre><code id="form-existing">&lt;script&gt;
// Auto-populate HubSpot forms with Refersion data
(function() {
    // Wait for form to be ready
    window.addEventListener('message', function(event) {
        if (event.data.type === 'hsFormCallback' && event.data.eventName === 'onFormReady') {
            const rfsnId = localStorage.getItem('rfsn');
            const timestamp = localStorage.getItem('rfsn_timestamp');
            const sourceUrl = localStorage.getItem('rfsn_source_url');
            
            if (rfsnId) {
                // Try to populate fields after a short delay
                setTimeout(function() {
                    const forms = document.querySelectorAll('.hs-form');
                    forms.forEach(function(form) {
                        // Set hidden field values
                        const fields = [
                            { name: 'refersionid', value: rfsnId },
                            { name: 'refersion_timestamp', value: timestamp || '' },
                            { name: 'refersion_source_url', value: sourceUrl || '' }
                        ];
                        
                        fields.forEach(function(field) {
                            const input = form.querySelector('input[name="' + field.name + '"]');
                            if (input) {
                                input.value = field.value;
                                input.dispatchEvent(new Event('change', { bubbles: true }));
                            }
                        });
                    });
                }, 100);
            }
        }
    });
})();
&lt;/script&gt;</code></pre>
      </div>
    </div>

    <div class="section">
      <h2>
        <span class="step-number">3</span>Conversion Tracking (Order
        Confirmation Page)
      </h2>
      <p>Add this to your order confirmation/thank you page</p>

      <div class="warning">
        <strong>‚ö†Ô∏è Important:</strong> This must run on the same domain as your
        site (not on a third-party checkout)
      </div>

      <div class="code-container">
        <button class="copy-button" onclick="copyCode('conversion-tracking')">
          Copy
        </button>
        <pre><code id="conversion-tracking">&lt;script&gt;
// Refersion Conversion Tracking
// Add this BEFORE the closing &lt;/body&gt; tag on your order confirmation page

// Replace these with actual order data from your checkout
var orderData = {
    order_id: 'ORDER-12345',           // Required: Unique order ID
    currency_code: 'USD',              // Required: 3-letter currency code
    customer_email: 'customer@email.com',
    customer_first_name: 'John',
    customer_last_name: 'Doe',
    shipping: 10.00,
    tax: 8.50,
    discount: 5.00,
    discount_code: 'SAVE5'
};

// Product data - add each product purchased
var products = [
    {
        sku: 'PROD-001',               // Required
        quantity: 1,                   // Required
        price: 99.99                   // Required: Individual item price
    },
    {
        sku: 'PROD-002',
        quantity: 2,
        price: 49.99
    }
];

// Send conversion to Refersion
if (typeof r !== 'undefined') {
    // Add transaction
    r('addTrans', {
        'order_id': orderData.order_id,
        'currency_code': orderData.currency_code,
        'shipping': orderData.shipping,
        'tax': orderData.tax,
        'discount': orderData.discount,
        'discount_code': orderData.discount_code
    });
    
    // Add customer
    r('addCustomer', {
        'first_name': orderData.customer_first_name,
        'last_name': orderData.customer_last_name,
        'email': orderData.customer_email,
        'ip_address': ''  // Leave empty for automatic detection
    });
    
    // Add items
    r('addItems', products);
    
    // Send conversion
    r('sendConversion');
    
    console.log('[Refersion] Conversion tracked for order:', orderData.order_id);
}
&lt;/script&gt;</code></pre>
      </div>

      <div class="info">
        <strong>‚ÑπÔ∏è Squarespace Commerce Note:</strong>
        <p>
          For Squarespace Commerce sites, you'll need to use their order
          confirmation code injection area and replace the static values with
          Squarespace's order variables:
        </p>
        <ul>
          <li><code>{orderId}</code> - Order number</li>
          <li><code>{customerEmailAddress}</code> - Customer email</li>
          <li><code>{totalPrice}</code> - Order total</li>
          <li>
            See Squarespace documentation for full list of available variables
          </li>
        </ul>
      </div>
    </div>

    <div class="section">
      <h2>üìä UTM Parameter Tracking</h2>

      <div class="success">
        <strong>‚úÖ Good news:</strong> HubSpot automatically tracks UTM
        parameters!
      </div>

      <p>
        HubSpot's tracking script automatically captures and stores these UTM
        parameters:
      </p>
      <ul>
        <li>
          <code>utm_source</code> - Traffic source (e.g., google, newsletter)
        </li>
        <li><code>utm_medium</code> - Marketing medium (e.g., cpc, email)</li>
        <li><code>utm_campaign</code> - Campaign name</li>
        <li><code>utm_term</code> - Paid search keywords</li>
        <li><code>utm_content</code> - Ad content/variation</li>
      </ul>

      <p>
        No additional code needed! These appear in HubSpot contact records under
        "Original source" and in the analytics.
      </p>
    </div>

    <div class="section">
      <h2>‚úÖ Refersion Best Practices Checklist</h2>

      <p>Our implementation follows all Refersion v4 best practices:</p>

      <table>
        <tr>
          <th>Best Practice</th>
          <th>Status</th>
          <th>Implementation</th>
        </tr>
        <tr>
          <td>V4 tracking enabled</td>
          <td>‚úÖ</td>
          <td>Using latest refersion.js CDN</td>
        </tr>
        <tr>
          <td>Script in &lt;head&gt; section</td>
          <td>‚úÖ</td>
          <td>Global scripts in Code Injection Header</td>
        </tr>
        <tr>
          <td>Track on every page</td>
          <td>‚úÖ</td>
          <td>Global Code Injection ensures site-wide tracking</td>
        </tr>
        <tr>
          <td>Click tracking</td>
          <td>‚úÖ</td>
          <td>r('click') called when referral detected</td>
        </tr>
        <tr>
          <td>Conversion tracking</td>
          <td>‚úÖ</td>
          <td>Full implementation with required parameters</td>
        </tr>
        <tr>
          <td>Same domain requirement</td>
          <td>‚úÖ</td>
          <td>All scripts run on your domain</td>
        </tr>
        <tr>
          <td>LocalStorage for persistence</td>
          <td>‚úÖ</td>
          <td>Referral data stored in localStorage</td>
        </tr>
        <tr>
          <td>Required order parameters</td>
          <td>‚úÖ</td>
          <td>order_id and currency_code included</td>
        </tr>
        <tr>
          <td>Required product parameters</td>
          <td>‚úÖ</td>
          <td>sku, quantity, and price for each item</td>
        </tr>
      </table>
    </div>

    <div class="section">
      <h2>üß™ Testing Your Implementation</h2>

      <ol>
        <li>
          <strong>Test Referral Capture:</strong> <br />Visit:
          <code>https://theloopway.com?rfsn=TEST123.affiliate</code> <br />Open
          Console (F12) ‚Üí Type: <code>localStorage.getItem('rfsn')</code>
          <br />Should return: <code>TEST123.affiliate</code>
        </li>

        <li>
          <strong>Test Form Population:</strong> <br />Fill out a form after
          visiting with referral link <br />Check HubSpot contact record for:
          <ul>
            <li>RefersionID field populated</li>
            <li>Timestamp recorded</li>
            <li>Source URL captured</li>
          </ul>
        </li>

        <li>
          <strong>Test Conversion Tracking:</strong> <br />Complete a test
          purchase <br />Check Refersion dashboard for conversion <br />Verify
          commission calculated correctly
        </li>
      </ol>
    </div>

    <div class="section">
      <h2>üö® Common Issues & Solutions</h2>

      <h3>Form fields not populating?</h3>
      <ul>
        <li>Ensure hidden fields are added to form in HubSpot</li>
        <li>
          Check field names match exactly: <code>refersionid</code>,
          <code>refersion_timestamp</code>, <code>refersion_source_url</code>
        </li>
        <li>Verify scripts load in correct order</li>
      </ul>

      <h3>Conversions not tracking?</h3>
      <ul>
        <li>Confirm order confirmation page is on same domain</li>
        <li>Check that order_id is unique for each order</li>
        <li>Verify Refersion public key is correct</li>
        <li>
          Enable debug mode: Add <code>r.settings.dbg_mode = true;</code> after
          pubkey line
        </li>
      </ul>

      <h3>Squarespace-specific issues?</h3>
      <ul>
        <li>
          Code Injection has character limits - use external files if needed
        </li>
        <li>Some templates may require scripts in Footer instead of Header</li>
        <li>Preview mode may not execute all scripts - test on live site</li>
      </ul>
    </div>

    <script>
      function copyCode(elementId) {
        const codeElement = document.getElementById(elementId);
        const textArea = document.createElement("textarea");
        textArea.value = codeElement.textContent;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand("copy");
        document.body.removeChild(textArea);

        // Update button text
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = "Copied!";
        setTimeout(() => {
          button.textContent = originalText;
        }, 2000);
      }
    </script>
  </body>
</html>
